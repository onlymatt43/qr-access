{% extends 'base.html' %}
{% block body %}
<h1>Validation QR</h1>
<input type="hidden" id="opaque" value="{{ opaque }}" />
<input type="hidden" id="device_id" value="{{ device_id }}" />
<button id="btn-scan">Scanner QR</button>
<input id="file" type="file" accept="image/*" capture="environment" style="display:none" />
<pre id="log"></pre>
<script>
const opaqueInUrl = document.getElementById('opaque').value;
const deviceId = document.getElementById('device_id').value;
const log = (m)=>document.getElementById('log').textContent += m+'\n';

async function redeem(opaque){
  const r = await fetch('/api/redeem', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({opaque, device_id: deviceId})});
  const data = await r.json();
  if(!r.ok){ log('Erreur: '+JSON.stringify(data)); return; }
  log('OK, token reçu, ouverture du contenu '+data.content_id);
  const rr = await fetch('/content/'+data.content_id, {headers:{'Authorization':'Bearer '+data.token}});
  document.body.innerHTML = await rr.text();
}

if (opaqueInUrl) redeem(opaqueInUrl);

document.getElementById('btn-scan').onclick = async ()=>{
  document.getElementById('file').click();
};

document.getElementById('file').addEventListener('change', async (e)=>{
  log('Image sélectionnée. (Décodage QR côté serveur à implémenter si nécessaire)');
});
</script>
{% endblock %}
